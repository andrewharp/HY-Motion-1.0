# HY-Motion-1.0 RunPod Serverless Dockerfile (with models baked in)
# Results in ~12GB image but no network volume needed

FROM runpod/pytorch:2.4.0-py3.11-cuda12.4.1-devel-ubuntu22.04

LABEL maintainer="HY-Motion Serverless"
LABEL description="HY-Motion-1.0 Serverless Worker with baked-in models"

ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV PIP_NO_CACHE_DIR=1
ENV PIP_BREAK_SYSTEM_PACKAGES=1

ENV PYTHONPATH="/app:/app/HY-Motion-1.0:/app/ComfyUI-HyMotion:${PYTHONPATH}"
ENV MODEL_PATH=/app/ckpts
ENV BLENDER_PATH=/usr/bin/blender
ENV OUTPUT_MODE=base64

# Install system deps
RUN apt-get update -qq && apt-get install -y --no-install-recommends \
    wget curl ca-certificates git git-lfs build-essential \
    protobuf-compiler libprotobuf-dev \
    libgl1-mesa-glx libxi6 libxrender1 libxkbcommon-x11-0 \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Install Blender
RUN wget -q https://download.blender.org/release/Blender4.0/blender-4.0.2-linux-x64.tar.xz \
    -O /tmp/blender.tar.xz && \
    tar -xf /tmp/blender.tar.xz -C /opt && \
    ln -s /opt/blender-4.0.2-linux-x64/blender /usr/bin/blender && \
    rm /tmp/blender.tar.xz

# Python deps
RUN pip install --no-cache-dir --upgrade pip setuptools wheel
RUN pip install --no-cache-dir \
    torch==2.5.1 torchvision==0.20.1 torchdiffeq==0.2.5 \
    accelerate==0.30.1 diffusers==0.26.3 transformers==4.53.3 \
    einops==0.8.1 safetensors==0.5.3 bitsandbytes==0.49.0
RUN pip install --no-cache-dir \
    "numpy>=1.24.0,<2.0" scipy>=1.10.0 transforms3d==0.4.2 \
    PyYAML==6.0 omegaconf==2.3.0 click==8.1.3
RUN pip install --no-cache-dir \
    requests==2.32.4 openai==1.78.1 huggingface_hub==0.30.0
RUN pip install --no-cache-dir runpod
RUN pip install --no-cache-dir fbxsdkpy --extra-index-url https://gitlab.inria.fr/api/v4/projects/18692/packages/pypi/simple

# Install ComfyUI
WORKDIR /app
RUN git clone --depth 1 --single-branch https://github.com/comfyanonymous/ComfyUI.git && \
    cd ComfyUI && pip install --no-cache-dir -r requirements.txt
RUN pip install --no-cache-dir comfy-kitchen comfy-aimdo

# Copy application code AND models
WORKDIR /app
COPY hymotion/ /app/hymotion/
COPY api/ /app/api/
COPY stats/ /app/stats/
COPY ckpts/ /app/ckpts/
COPY ComfyUI-HyMotion/ /app/ComfyUI-HyMotion/
COPY runpod_handler.py /app/runpod_handler.py

# Fix config paths
RUN sed -i 's|mean_std_dir: ./stats/|mean_std_dir: /app/stats/|g' \
    /app/ckpts/tencent/HY-Motion-1.0/config.yml 2>/dev/null || true

# Verify models exist
RUN ls -lah /app/ckpts/tencent/HY-Motion-1.0/ && \
    test -f /app/ckpts/tencent/HY-Motion-1.0/config.yml && \
    echo "âœ“ Models verified"

CMD ["python3", "/app/runpod_handler.py"]
