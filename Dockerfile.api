# HY-Motion-1.0 API Dockerfile
# FastAPI service with models DOWNLOADED during build (baked into image)
# No network volume required

FROM runpod/pytorch:1.0.2-cu1281-torch280-ubuntu2404

LABEL maintainer="HY-Motion API"
LABEL description="HY-Motion-1.0 Retargeting API with baked-in models"

ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV PIP_NO_CACHE_DIR=1
ENV PIP_BREAK_SYSTEM_PACKAGES=1

ENV PYTHONPATH="/app:/app/HY-Motion-1.0:/app/ComfyUI-HyMotion:/app/ComfyUI:${PYTHONPATH}"
ENV CKPTS_DIR=/app/HY-Motion-1.0/ckpts
ENV COMFYUI_PATH=/app/ComfyUI
ENV USE_HF_MODELS=0
ENV HF_HOME=/app/.cache/huggingface

# Install system dependencies (including X11 libs for Blender)
# Ubuntu 24.04 package names (different from 22.04)
RUN apt-get update -qq && apt-get install -y --no-install-recommends \
    git-lfs protobuf-compiler libprotobuf-dev python3-yaml \
    libgl1 libxi6 libxrender1 libxkbcommon0 libsm6 libexpat1 \
    && rm -rf /var/lib/apt/lists/*

# Install Blender
RUN wget -q https://download.blender.org/release/Blender4.0/blender-4.0.2-linux-x64.tar.xz -O /tmp/blender.tar.xz && \
    tar -xf /tmp/blender.tar.xz -C /opt && \
    ln -s /opt/blender-4.0.2-linux-x64/blender /usr/local/bin/blender && \
    ln -s /opt/blender-4.0.2-linux-x64/blender /usr/bin/blender && \
    rm /tmp/blender.tar.xz && \
    blender --version

# Install Python dependencies
RUN pip install --upgrade pip setuptools wheel

# Install FastAPI and dependencies
RUN pip install --no-cache-dir \
    fastapi uvicorn python-multipart pydantic requests aiohttp openai

# Install HY-Motion dependencies
RUN pip install --no-cache-dir \
    huggingface_hub==0.30.0 torchdiffeq==0.2.5 \
    accelerate==0.30.1 diffusers==0.26.3 transformers==4.53.3 \
    einops==0.8.1 safetensors==0.5.3 scipy>=1.10.0 \
    transforms3d==0.4.2 omegaconf==2.3.0 click==8.1.3

# Install FBX SDK
RUN pip install --no-cache-dir fbxsdkpy --extra-index-url https://gitlab.inria.fr/api/v4/projects/18692/packages/pypi/simple

# Clone ComfyUI
WORKDIR /app
RUN git clone --depth 1 https://github.com/comfyanonymous/ComfyUI.git && \
    cd ComfyUI && \
    pip install --no-cache-dir -r requirements.txt

# Install ComfyUI-HyMotion dependencies
RUN pip install --no-cache-dir comfy-kitchen comfy-aimdo

# Clone HY-Motion-1.0
RUN git clone --depth 1 https://github.com/Tencent-Hunyuan/HY-Motion-1.0.git && \
    cd HY-Motion-1.0 && \
    rm -rf ckpts  # We'll download models separately
RUN git clone --depth 1 https://github.com/jtydhr88/ComfyUI-HY-Motion1.git ComfyUI-HyMotion

# =============================================================================
# DOWNLOAD MODELS DURING BUILD (baked into image)
# =============================================================================

WORKDIR /app/HY-Motion-1.0

# Create ckpts directory structure
RUN mkdir -p ckpts/tencent

# Download HY-Motion-1.0 models from HuggingFace
RUN echo "=== Downloading HY-Motion-1.0 models ===" && \
    huggingface-cli download tencent/HY-Motion-1.0 \
        --include "HY-Motion-1.0/*" \
        --local-dir ckpts/tencent \
        --local-dir-use-symlinks False && \
    echo "✓ HY-Motion-1.0 models downloaded"

# Download CLIP text encoder
RUN echo "=== Downloading CLIP text encoder ===" && \
    huggingface-cli download openai/clip-vit-large-patch14 \
        --local-dir ckpts/clip-vit-large-patch14 \
        --local-dir-use-symlinks False && \
    echo "✓ CLIP downloaded"

# Download Qwen text encoder (optional, for prompt rewriting)
RUN echo "=== Downloading Qwen text encoder ===" && \
    huggingface-cli download Qwen/Qwen3-8B \
        --local-dir ckpts/Qwen3-8B \
        --local-dir-use-symlinks False || \
    echo "⚠ Qwen download failed (optional)"

# Verify models are present
RUN echo "=== Verifying model files ===" && \
    ls -lah ckpts/tencent/HY-Motion-1.0/ && \
    test -f ckpts/tencent/HY-Motion-1.0/config.yml && \
    (test -f ckpts/tencent/HY-Motion-1.0/latest.ckpt || \
     test -f ckpts/tencent/HY-Motion-1.0/latest.pt) && \
    echo "✓ Model files verified" && \
    du -sh ckpts/

# Copy API files
COPY api/ /app/api/
COPY hymotion/ /app/hymotion/
COPY stats/ /app/stats/

# Fix text_encoder meta tensor issue
RUN python3 /app/api/patch_text_encoder.py || echo "Patch script completed"

# Fix config paths for container
RUN sed -i 's|mean_std_dir: ./stats/|mean_std_dir: /app/stats/|g' \
    /app/HY-Motion-1.0/ckpts/tencent/HY-Motion-1.0/config.yml

WORKDIR /app

EXPOSE 8000

HEALTHCHECK --interval=30s --timeout=10s --start-period=120s --retries=3 \
    CMD python3 -c "import requests; requests.get('http://localhost:8000/health', timeout=5)" || exit 1

# Startup script
COPY api/entrypoint.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh

ENTRYPOINT ["/app/entrypoint.sh"]
